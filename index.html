<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendamento Barbearia</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to bottom, #e3f2fd, #ffffff);
    margin: 0;
    padding: 0 20px;
  }
  h1, h2 { color: #1a73e8; }
  .container { max-width: 600px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  label { display: block; margin-top: 10px; }
  select, input, button { width: 100%; padding: 8px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; }
  button { background-color: #1a73e8; color: #fff; border: none; cursor: pointer; font-weight: bold; }
  button:hover { background-color: #155ab6; }
  .admin { background: #e8f0fe; padding: 15px; margin-top: 20px; border-radius: 12px; }
  ul { padding-left: 20px; }
</style>
</head>
<body>

<div class="container">
  <h1>Barbearia do Orlando</h1>

  <!-- Login -->
  <div class="login">
    <h2>Login</h2>
    <label>Email:</label>
    <input type="email" id="email" placeholder="Email">
    <label>Senha:</label>
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="login()">Entrar</button>
    <p id="loginMsg"></p>
  </div>

  <!-- Cliente -->
  <div class="cliente" style="display:none;">
    <h2>Agendar Serviço</h2>
    <label>Serviço:</label>
    <select id="servicoSelect"></select>

    <label>Data:</label>
    <input type="date" id="dataInput">

    <label>Hora:</label>
    <select id="horaSelect"></select>

    <button onclick="agendar()">Agendar</button>
    <p id="agendamentoMsg"></p>
  </div>

  <!-- Admin -->
  <div class="admin" style="display:none;">
    <h2>Bloquear Horário</h2>
    <label>Data:</label>
    <input type="date" id="adminData">

    <label>Hora:</label>
    <select id="adminHora"></select>

    <label>Motivo:</label>
    <input type="text" id="adminMotivo">

    <button onclick="bloquear()">Bloquear</button>
    <p id="bloqueioMsg"></p>

    <h3>Agenda fechada</h3>
    <ul id="listaBloqueios"></ul>
  </div>

  <h2>Agendamentos</h2>
  <ul id="listaAgendamentos"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  const SUPABASE_URL = "https://gskvkziggkqkfdwnubih.supabase.co"; // substitua
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdza3ZremlnZ2txa2Zkd251YmloIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzI1NjYxMCwiZXhwIjoyMDcyODMyNjEwfQ.8Wy0beQokGW2MpYzR9Zx20SOxYUO7IyDC68Fv4xbdis"; // substitua
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let usuarioAtual = null;

  async function login() {
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });
    if (error) {
      document.getElementById('loginMsg').textContent = "Erro: " + error.message;
      return;
    }
    usuarioAtual = data.user;
    const perfil = await supabase.from('users').select('tipo').eq('id', usuarioAtual.id).single();
    document.querySelector('.login').style.display = 'none';
    if (perfil.data.tipo === 'cliente') {
      document.querySelector('.cliente').style.display = 'block';
    } else {
      document.querySelector('.admin').style.display = 'block';
    }
    carregarServicos();
    gerarHorarios();
    carregarBloqueios();
    carregarAgendamentos();
  }

  async function carregarServicos() {
    const { data, error } = await supabase.from('services').select('*');
    if (error) return console.error(error);
    const select = document.getElementById('servicoSelect');
    select.innerHTML = '';
    data.forEach(s => {
      const option = document.createElement('option');
      option.value = s.id;
      option.textContent = `${s.nome} (${s.duracao} min)`;
      select.appendChild(option);
    });
  }

  function gerarHorarios() {
    const selectCliente = document.getElementById('horaSelect');
    const selectAdmin = document.getElementById('adminHora');
    selectCliente.innerHTML = '';
    selectAdmin.innerHTML = '';
    let hora = 9; // abre às 09:00
    const fim = 18; // fecha às 18:00
    while (hora < fim) {
      ['00','40'].forEach(min => {
        const h = hora.toString().padStart(2,'0') + ':' + min;
        const opt1 = document.createElement('option');
        opt1.value = h; opt1.textContent = h;
        selectCliente.appendChild(opt1);
        const opt2 = document.createElement('option');
        opt2.value = h; opt2.textContent = h;
        selectAdmin.appendChild(opt2);
      });
      hora++;
    }
  }

  async function carregarBloqueios() {
    const { data, error } = await supabase.from('blocked_slots').select('*').order('data');
    if (error) return console.error(error);
    const lista = document.getElementById('listaBloqueios');
    lista.innerHTML = '';
    data.forEach(b => {
      const li = document.createElement('li');
      li.textContent = `${b.data || ''} ${b.hora || ''} - ${b.motivo}`;
      lista.appendChild(li);
    });
  }

  async function carregarAgendamentos() {
    const { data, error } = await supabase.from('appointments').select('*, services(*)').order('data');
    if (error) return console.error(error);
    const lista = document.getElementById('listaAgendamentos');
    lista.innerHTML = '';
    data.forEach(a => {
      const li = document.createElement('li');
      li.textContent = `${a.data} ${a.hora} - ${a.services.nome} (Cliente: ${a.user_id})`;
      lista.appendChild(li);
    });
  }

  async function agendar() {
    const serviceId = document.getElementById('servicoSelect').value;
    const data = document.getElementById('dataInput').value;
    const hora = document.getElementById('horaSelect').value;

    // Verifica bloqueios
    const { data: bloqueios } = await supabase.from('blocked_slots').select('*')
      .eq('data', data)
      .eq('hora', hora);
    if (bloqueios.length > 0) {
      document.getElementById('agendamentoMsg').textContent = 'Horário bloqueado!';
      return;
    }

    const { error } = await supabase.from('appointments').insert([
      { user_id: usuarioAtual.id, service_id: serviceId, data, hora }
    ]);
    if (error) {
      document.getElementById('agendamentoMsg').textContent = 'Erro ao agendar: ' + error.message;
    } else {
      document.getElementById('agendamentoMsg').textContent = 'Agendamento criado!';
      carregarAgendamentos();
    }
  }

  async function bloquear() {
    const data = document.getElementById('adminData').value;
    const hora = document.getElementById('adminHora').value;
    const motivo = document.getElementById('adminMotivo').value;

    const { error } = await supabase.from('blocked_slots').insert([
      { data, hora, motivo, admin_id: usuarioAtual.id }
    ]);
    if (error) {
      document.getElementById('bloqueioMsg').textContent = 'Erro ao bloquear: ' + error.message;
    } else {
      document.getElementById('bloqueioMsg').textContent = 'Horário bloqueado!';
      carregarBloqueios();
    }
  }

</script>
</body>
</html>